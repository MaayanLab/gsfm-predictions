import React from 'react';
import trpc from '@/lib/trpc/server'
import Link from 'next/link';
import { Waypoints } from '@/components/waypoint';
import AllPredictions from '@/components/gene/AllPredictions';
import { notFound } from 'next/navigation';
import ReactMarkdown from 'react-markdown'
import remarkGfm from 'remark-gfm'

export default async function Home({ params }: { params: Promise<{ gene: string }> }) {
  const gene_info = await trpc.gene_info((await params).gene)
  if (!gene_info) notFound()
  const models = await trpc.models()
  return (
    <main className="container mx-auto flex flex-col gap-4 items-stretch grow">
      <Waypoints>
        <div className="prose max-w-full border border-b-0 border-secondary rounded-t-lg p-4">
          <h1 className="mb-0">{gene_info.symbol}</h1>
          <h5 className="mt-0">{gene_info.name}</h5>
          <div role="tablist" className="tabs tabs-lift tabs-lg">
            <input type="radio" name="my_tabs" role="tab" className="tab whitespace-nowrap" aria-label="NCBI Description" disabled={!gene_info.description} defaultChecked />
            <div role="tabpanel" className="tab-content bg-base-100 border-base-300 rounded-box px-6 prose prose-xl max-w-none">
              <p>{gene_info.description ?? ''}</p>
              <p><i>Sourced from NCBI EUtils.</i></p>
            </div>

            <input type="radio" name="my_tabs" role="tab" className="tab whitespace-nowrap" aria-label="AI Overview (DeepDive GPT4o)" disabled={!gene_info.deepdive_gpt4o_description} defaultChecked={!gene_info.description} />
            <div role="tabpanel" className="tab-content bg-base-100 border-base-300 rounded-box px-6 prose prose-xl max-w-none">
              <div className="prose-p:m-0" dangerouslySetInnerHTML={{ __html: gene_info.deepdive_gpt4o_description ?? '' }} />
              <p><i>Generated by summarizing the top 50 most cited paper abstracts that mention this gene using gpt4o-mini (DeepDive).</i></p>
            </div>

            {gene_info.deepdive_gemini_description && <>
              <input type="radio" name="my_tabs" role="tab" className="tab whitespace-nowrap" aria-label="AI Overview (DeepDive Gemini)" />
              <div role="tabpanel" className="tab-content bg-base-100 border-base-300 rounded-box px-6 prose prose-xl max-w-none prose-p:m-0">
                <style>{`
                  [aria-describedby="footnote-label"] {
                    margin-left: 2px;
                  }
                `}</style>
                <ReactMarkdown
                  remarkPlugins={[remarkGfm]}
                  components={{
                    h2: ({ children, ...props }) =>
                      props.id === 'footnote-label' ? <h2 {...props}>References</h2>
                    : <h2 {...props} />
                  }}
                >{gene_info.deepdive_gemini_description}</ReactMarkdown>
              </div>
            </>}

            {!gene_info.description && !gene_info.deepdive_gpt4o_description && !gene_info.deepdive_gemini_description && <>
              <input type="radio" name="my_tabs" role="tab" className="tab whitespace-nowrap" aria-label="Coming Soon" defaultChecked />
              <div role="tabpanel" className="tab-content bg-base-100 border-base-300 rounded-box px-6 prose prose-xl max-w-none">
                <p>Descriptions for this gene are not yet available but should be coming soon!</p>
              </div>
            </>}
          </div>
        </div>
        {models.map(({ model }) => 
          <div key={model} className="prose max-w-full border border-t-0 border-secondary rounded-b-lg p-4">
            <div className="flex flex-row">
              {/* <img src={undefined} alt="GSFM" /> */}
              <div className="w-24 h-24 border m-4 self-center">&nbsp;</div>
              <div className="flex flex-col">
                <h2>GSFM gene annotation predictions ({model})</h2>
                <p>The gene annotations below have been generated using GSFM. GSFM uses is an auto-encoder-like deep machine learning model trained on gene sets from supplemental material of literature. More information about the method can be found <Link href="/about">here</Link>.</p>
              </div>
            </div>
            <AllPredictions model={model} />
          </div>
        )}
      </Waypoints>
    </main>
  )
}
