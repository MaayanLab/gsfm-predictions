'use client'

import React from 'react'
import MDT from '@/components/mdt'
import useRWSearchParams from '@/components/rwsearchparams'
import type trpc from '@/lib/trpc/server'
import { UnPromise } from '@/components/types'
import classNames from 'classnames'

export default function GeneInfo({ gene_info }: { gene_info: Exclude<UnPromise<ReturnType<typeof trpc.gene_info>>, undefined> }) {
  const [searchParams, setSearchParams] = useRWSearchParams()
  const ncbi_available = React.useMemo(() => !!gene_info.description, [gene_info])
  const gpt4o_available = React.useMemo(() => gene_info.deepdive_gpt4o_description && JSON.parse(gene_info.deepdive_gpt4o_description), [gene_info])
  const gemini_available = React.useMemo(() => gene_info.deepdive_gemini_description && JSON.parse(gene_info.deepdive_gemini_description), [gene_info])
  React.useEffect(() => {
    if (searchParams.get('geneinfo') === null && !gene_info.description) {
      if (gpt4o_available) setSearchParams(sp => sp.set('geneinfo', 'gpt4o'), { scroll: false })
      else if (gemini_available) setSearchParams(sp => sp.set('geneinfo', 'gemini'), { scroll: false })
    }
  }, [gpt4o_available, gemini_available, gene_info, searchParams, setSearchParams])

  return (
    <div className="prose max-w-full p-4 flex flex-col overflow-hidden relative">
      <div className="flex flex-col gap-8 mb-8">
        <h1 className="mb-0 text-6xl text-primary">{gene_info.symbol}</h1>
        <h5 className="mt-0 text-2xl text-primary">{gene_info.name}</h5>
      </div>
      <div className="flex flex-col items-stretch place-items-stretch overflow-auto">
        <div role="tablist" className="tabs tabs-lift tabs-xl min-w-max gap-2">
          {(ncbi_available || gpt4o_available || gemini_available) && <>
            <button
              role="tab"
              className={classNames("tab border-[#013CC6] whitespace-nowrap rounded-t-2xl border-t border-x border-dashed bg-[#F9FAFE] text-primary", { 'bg-white tab-active border-solid': searchParams.get('geneinfo') === null })}
              onClick={evt => {evt.preventDefault(); setSearchParams(sp => { sp.delete('geneinfo') }, { scroll: false })}}
            >
              NCBI Description
            </button>
          </>}

          {gpt4o_available && gene_info.deepdive_gpt4o_description && <>
            <button
              role="tab"
              className={classNames("tab border-[#013CC6] whitespace-nowrap rounded-t-2xl border-t border-x border-dashed bg-[#F9FAFE] text-primary", { 'bg-white tab-active border-solid': searchParams.get('geneinfo') === 'gpt4o' })}
              onClick={evt => {evt.preventDefault(); setSearchParams(sp => { sp.set('geneinfo', 'gpt4o') }, { scroll: false })}}
            >
              AI Overview (DeepDive GPT4o)
            </button>
          </>}

          {gemini_available && gene_info.deepdive_gemini_description && <>
            <button
              role="tab"
              className={classNames("tab border-[#013CC6] whitespace-nowrap rounded-t-2xl border-t border-x border-dashed bg-[#F9FAFE] text-primary", { 'bg-white tab-active border-solid': searchParams.get('geneinfo') === 'gemini' })}
              onClick={evt => {evt.preventDefault(); setSearchParams(sp => { sp.set('geneinfo', 'gemini') }, { scroll: false })}}
            >
              AI Overview (DeepDive Gemini)
            </button>
          </>}

          {!ncbi_available && !gpt4o_available && !gemini_available && <>
            <button
              role="tab"
              className={classNames("tab border-[#013CC6] whitespace-nowrap text-primary bg-white tab-active")}
            >
              Coming Soon
            </button>
          </>}
        </div>
        <div>
          {ncbi_available && searchParams.get('geneinfo') === null && <>
            <div role="tabpanel" className="block tab-content border-[#013CC6] border  rounded-2xl rounded-tl-none p-6 prose max-w-none">
              <p>{gene_info.description ?? ''}</p>
              <p><i>Sourced from NCBI EUtils.</i></p>
            </div>
          </>}
          
          {gpt4o_available && gene_info.deepdive_gpt4o_description && searchParams.get('geneinfo') === 'gpt4o' && <>
            <div role="tabpanel" className="block tab-content border-[#013CC6] border rounded-2xl rounded-tl-none p-6 prose max-w-none">
              <MDT src={(gene_info.deepdive_gpt4o_description)} />
              <p><i>Generated by summarizing the top 50 most cited paper abstracts that mention this gene using gpt4o-mini (DeepDive).</i></p>
            </div>
          </>}

          {gemini_available && gene_info.deepdive_gemini_description && searchParams.get('geneinfo') === 'gemini' && <>
            <div role="tabpanel" className="block tab-content border-[#013CC6] border rounded-2xl rounded-tl-none p-6 prose max-w-none">
              <MDT src={(gene_info.deepdive_gemini_description)} />
              <p><i>Generated by summarizing the top 50 most cited paper abstracts that mention this gene using gemini (DeepDive).</i></p>
            </div>
          </>}

          {!ncbi_available && !gpt4o_available && !gemini_available && <>
            <div role="tabpanel" className="block tab-content border-[#013CC6] border rounded-2xl rounded-tl-none prose prose-xl max-w-none">
              <p>Descriptions for this gene are not yet available but should be coming soon!</p>
            </div>
          </>}
        </div>
      </div>
    </div>
  )
}